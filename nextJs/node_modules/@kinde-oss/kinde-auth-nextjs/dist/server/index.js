import{cookies as e}from"next/headers";import{GrantType as t,createKindeServerClient as r,Configuration as n,UsersApi as s,OAuthApi as a,SubscribersApi as i,OrganizationsApi as o,ConnectedAppsApi as c,FeatureFlagsApi as l,EnvironmentsApi as u,PermissionsApi as g,RolesApi as d,BusinessApi as p,IndustriesApi as h,TimezonesApi as _,ApplicationsApi as m,CallbacksApi as y,APIsApi as k}from"@kinde-oss/kinde-typescript-sdk";import w from"react";import f from"jwt-decode";import{redirect as S}from"next/navigation";import{NextResponse as I}from"next/server";const R=e=>e instanceof Request;var U=require("cookie");const A=(t,r)=>t?R(t)?P(e()):L(t,r):P(e()),P=e=>({getSessionItem:t=>{const r=e.get(t);if(r)try{const e=JSON.parse(r.value);return"object"==typeof e?e:r.value}catch(e){return r.value}},setSessionItem:(t,r)=>e.set(t,"object"==typeof r?JSON.stringify(r):r),removeSessionItem:t=>e.delete(t),destroySession:()=>{["id_token_payload","id_token","access_token_payload","access_token","user","refresh_token"].forEach((t=>e.delete(t)))}}),L=(e,t)=>({getSessionItem:t=>{const r=e.cookies[t];if(r)try{const e=JSON.parse(r);return"object"==typeof e?e:r}catch(e){return r}},setSessionItem:(e,r)=>{let n=t.getHeader("Set-Cookie")||[];Array.isArray(n)||(n=[n]),t.setHeader("Set-Cookie",[...n.filter((t=>!t.startsWith(`${e}=`))),U.serialize(e,"object"==typeof r?JSON.stringify(r):r,{path:"/"})])},removeSessionItem:e=>{t.setHeader("Set-Cookie",U.serialize(e,"",{path:"/",maxAge:-1}))},destroySession:()=>{t.setHeader("Set-Cookie",["id_token_payload","id_token","access_token_payload","access_token","user","refresh_token"].map((e=>U.serialize(e,"",{path:"/",maxAge:-1}))))}}),T=(e,t)=>async()=>await A(e,t).getSessionItem("access_token_payload"),E=process.env.KINDE_SITE_URL,O=process.env.NEXT_PUBLIC_KINDE_AUTH_API_PATH||process.env.KINDE_AUTH_API_PATH||"/api/auth",v=process.env.KINDE_POST_LOGIN_REDIRECT_URL||process.env.KINDE_POST_LOGIN_URL_REDIRECT_URL,C=process.env.KINDE_POST_LOGOUT_REDIRECT_URL,b=process.env.KINDE_ISSUER_URL,N=process.env.KINDE_CLIENT_ID,M=process.env.KINDE_CLIENT_SECRET,j=process.env.KINDE_AUDIENCE,D={apiPath:O,initialState:{accessToken:null,idToken:null,isAuthenticated:!1,isLoading:!0,organization:null,permissions:[],user:null,userOrganiaztions:[],getAccessToken:()=>null,getBooleanFlag:()=>null,getClaim:()=>null,getFlag:()=>null,getIdToken:()=>null,getIntegerFlag:()=>null,getOrganization:()=>null,getPermission:()=>null,getPermissions:()=>[],getStringFlag:()=>null,getToken:()=>null,getUser:()=>null,getUserOrganizations:()=>null},SESSION_PREFIX:"pkce-verifier",redirectURL:E,postLoginRedirectURL:v,issuerURL:b,clientID:N,clientSecret:M,postLogoutRedirectURL:C,audience:j,responseType:"code",scope:"openid profile email offline",codeChallengeMethod:"S256",redirectRoutes:{callback:`${O}/kinde_callback`},issuerRoutes:{logout:"/logout",login:"/oauth2/auth",register:"/oauth2/auth",token:"/oauth2/token",profile:"/oauth2/v2/user_profile"},clientOptions:{audience:j||"",authDomain:b||"",clientId:N||"",clientSecret:M||"",logoutRedirectURL:C||"",redirectURL:`${E}/api/auth/kinde_callback`,frameworkVersion:"2.0.4",framework:"Next.js"},grantType:t.AUTHORIZATION_CODE},z=r(D.grantType,D.clientOptions),$=(e,t)=>async(r,n,s)=>{try{return await z.getFlag(A(e,t),r,n,s)}catch(e){if(e.message.includes("no default value has been provided"))throw e;return{value:n}}},F=(e,t)=>async(r,n)=>{try{return(await $(e,t)(r,n,"b")).value}catch(e){return console.error(e),null}},K=(e,t)=>async()=>await A(e,t).getSessionItem("id_token_payload"),x=(e,t)=>async(r,n)=>{try{return(await $(e,t)(r,n,"i")).value}catch(e){return console.error(e),null}},H=(e,t)=>async()=>{try{return await z.getOrganization(A(e,t))}catch(e){return null}},q=(e,t)=>async r=>{try{return await z.getPermission(A(e,t),r)}catch(e){return null}},V=(e,t)=>async()=>{try{return await z.getPermissions(A(e,t))}catch(e){return null}},B=(e,t)=>async(r,n)=>{try{return(await $(e,t)(r,n,"s")).value}catch(e){return console.error(e),null}},J=(e,t)=>async()=>{try{return await z.getUser(A(e,t))}catch(e){return null}},G=(e,t)=>async()=>{try{return await z.getUserOrganizations(A(e,t))}catch(e){return null}},X=(e,t)=>async()=>{const r=await J(e,t)();return Boolean(r)};function W(e,t){return{getAccessToken:T(e,t),getBooleanFlag:F(e,t),getFlag:$(e,t),getIdToken:K(e,t),getIntegerFlag:x(e,t),getOrganization:H(e,t),getPermission:q(e,t),getPermissions:V(e,t),getStringFlag:B(e,t),getUser:J(e,t),getUserOrganizations:G(e,t),isAuthenticated:X(e,t)}}function Z(){return Z=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},Z.apply(this,arguments)}function Q({children:e,orgCode:t,postLoginRedirectURL:r,authUrlParams:n,...s}){let a=new URLSearchParams,i={};null!=t&&(i.org_code=t),null!=r&&(i.post_login_redirect_url=r),i={...n,...i};for(const e in i)a.append(e,i[e]);return w.createElement("a",Z({href:`${D.apiPath}/register${a?`?${a.toString()}`:""}`},s),e)}function Y({children:e,postLoginRedirectURL:t,orgCode:r,authUrlParams:n,...s}){let a=new URLSearchParams,i={};null!=r&&(i.org_code=r),null!=t&&(i.post_login_redirect_url=t),i={...n,...i};for(const e in i)a.append(e,i[e]);return w.createElement("a",Z({href:`${D.apiPath}/login${a?`?${a.toString()}`:""}`},s),e)}function ee({children:e,...t}){return w.createElement("a",Z({href:`${D.apiPath}/logout`},t),e)}function te({children:e,orgName:t,...r}){return w.createElement("a",Z({href:`${D.apiPath}/create_org${t?`?org_name=${t}`:""}`},r),e)}const re=async(e,t)=>{let r=null;const w=A(e,t),S=w.getSessionItem("kinde_api_access_token");if((e=>{const t=e&&e.access_token||e;if(!t)return!1;const r=f(t,{header:!0}),n=f(t);let s=!0;return D.audience&&(s=n.aud&&n.aud.includes(D.audience)),!!(n.iss==D.issuerURL&&"RS256"==r.alg&&n.exp>Math.floor(Date.now()/1e3)&&s)})(S))r=S;else{const e=await fetch(`${D.issuerURL}/oauth2/token`,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:D.clientID,client_secret:D.clientSecret,audience:D.audience})});r=(await e.json()).access_token;try{w.setSessionItem("kinde_api_access_token",r)}catch(e){console.error(e)}}const I=new n({basePath:D.issuerURL,accessToken:r,headers:{Accept:"application/json"}});return{usersApi:new s(I),oauthApi:new a(I),subscribersApi:new i(I),organizationsApi:new o(I),connectedAppsApi:new c(I),featureFlagsApi:new l(I),environmentsApi:new u(I),permissionsApi:new g(I),rolesApi:new d(I),businessApi:new p(I),industriesApi:new h(I),timezonesApi:new _(I),applicationsApi:new m(I),callbacksApi:new y(I),apisApi:new k(I)}};class ne{constructor(t,n){this.kindeClient=r(D.grantType,D.clientOptions),this.url=new URL(t.url),this.sessionManager=P(e()),this.req=t,this.searchParams=t.nextUrl.searchParams}redirect(e){return S(e)}getUrl(){return this.url}json(e,t){return I.json(e,t)}error(){return I.error}getSearchParam(e){return this.req.nextUrl.searchParams.get(e)}}class se{constructor(e,t){this.kindeClient=r(D.grantType,D.clientOptions),this.url=new URL(D.redirectURL+e.url),this.res=t,this.req=e,this.searchParams=this.url.searchParams,this.sessionManager=A(e,t)}redirect(e){return this.res.redirect(e.href?e.href:e)}getUrl(){return this.url}json(e,t=200){return this.res.status(t).json(e)}getSearchParam(e){return this.url.searchParams.get(e)}}const ae={create_org:async e=>{const t={org_name:e.getSearchParam("org_name"),is_create_org:!0},r=await e.kindeClient.createOrg(e.sessionManager,t);e.redirect(r)},register:async e=>{const t=await e.kindeClient.register(e.sessionManager,{authUrlParams:Object.fromEntries(e.searchParams)}),r=e.getSearchParam("post_login_redirect_url");r&&await e.sessionManager.setSessionItem("post_login_redirect_url",r),e.redirect(t)},setup:async e=>{const t=await e.sessionManager.getSessionItem("user");if(t){const r=await e.sessionManager.getSessionItem("access_token_payload"),n=await e.sessionManager.getSessionItem("id_token_payload"),s=await e.sessionManager.getSessionItem("access_token"),a=await e.kindeClient.getClaimValue(e.sessionManager,"permissions"),i=await e.kindeClient.getClaimValue(e.sessionManager,"org_code"),o=await e.kindeClient.getClaimValue(e.sessionManager,"feature_flags"),c=await e.kindeClient.getClaimValue(e.sessionManager,"org_codes","id_token");return e.json({accessToken:r,accessTokenEncoded:s,idToken:n,user:t,permissions:{permissions:a,orgCode:i},organization:i,featureFlags:o,userOrganizations:c})}return e.json({error:"Log in with Kinde"},{status:401})},login:async e=>{const t=await e.kindeClient.login(e.sessionManager,{authUrlParams:Object.fromEntries(e.searchParams)}),r=e.getSearchParam("post_login_redirect_url");r&&await e.sessionManager.setSessionItem("post_login_redirect_url",r),e.redirect(t)},logout:async e=>{const t=await e.kindeClient.logout(e.sessionManager);e.redirect(t)},kinde_callback:async e=>{const t=await e.sessionManager.getSessionItem("post_login_redirect_url");t&&await e.sessionManager.removeSessionItem("post_login_redirect_url");const r=t||D.postLoginRedirectURL;await e.kindeClient.handleRedirectToApp(e.sessionManager,e.getUrl()),e.redirect(r)}},ie=e=>ae[e];var oe=(e,t)=>"object"==typeof e&&"string"==typeof t?ce(e,{params:{kindeAuth:t}}):async function(e,t){return R(e)?ce(e,t):le(e,t)};const ce=async(e,t)=>{const{params:r}=t;let n=r.kindeAuth;n=Array.isArray(n)?n[0]:n;const s=ie(n);return s?await s(new ne(e,t)):new Response("This page could not be found.",{status:404})},le=async(e,t)=>{let{query:{kindeAuth:r}}=e;r=Array.isArray(r)?r[0]:r;const n=ie(r);return n?await n(new se(e,t)):t.status(404).end()};export{te as CreateOrgLink,Y as LoginLink,ee as LogoutLink,Q as RegisterLink,re as createKindeManagementAPIClient,W as getKindeServerSession,oe as handleAuth};
//# sourceMappingURL=index.js.map
