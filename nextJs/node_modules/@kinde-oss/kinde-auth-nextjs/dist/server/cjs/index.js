"use strict";var e=require("next/headers"),t=require("@kinde-oss/kinde-typescript-sdk"),r=require("react"),n=require("jwt-decode"),s=require("next/navigation"),a=require("next/server");const i=e=>e instanceof Request;var o=require("cookie");const c=(t,r)=>t?i(t)?l(e.cookies()):u(t,r):l(e.cookies()),l=e=>({getSessionItem:t=>{const r=e.get(t);if(r)try{const e=JSON.parse(r.value);return"object"==typeof e?e:r.value}catch(e){return r.value}},setSessionItem:(t,r)=>e.set(t,"object"==typeof r?JSON.stringify(r):r),removeSessionItem:t=>e.delete(t),destroySession:()=>{["id_token_payload","id_token","access_token_payload","access_token","user","refresh_token"].forEach((t=>e.delete(t)))}}),u=(e,t)=>({getSessionItem:t=>{const r=e.cookies[t];if(r)try{const e=JSON.parse(r);return"object"==typeof e?e:r}catch(e){return r}},setSessionItem:(e,r)=>{let n=t.getHeader("Set-Cookie")||[];Array.isArray(n)||(n=[n]),t.setHeader("Set-Cookie",[...n.filter((t=>!t.startsWith(`${e}=`))),o.serialize(e,"object"==typeof r?JSON.stringify(r):r,{path:"/"})])},removeSessionItem:e=>{t.setHeader("Set-Cookie",o.serialize(e,"",{path:"/",maxAge:-1}))},destroySession:()=>{t.setHeader("Set-Cookie",["id_token_payload","id_token","access_token_payload","access_token","user","refresh_token"].map((e=>o.serialize(e,"",{path:"/",maxAge:-1}))))}}),g=(e,t)=>async()=>await c(e,t).getSessionItem("access_token_payload"),p=process.env.KINDE_SITE_URL,d=process.env.NEXT_PUBLIC_KINDE_AUTH_API_PATH||process.env.KINDE_AUTH_API_PATH||"/api/auth",h=process.env.KINDE_POST_LOGIN_REDIRECT_URL||process.env.KINDE_POST_LOGIN_URL_REDIRECT_URL,_=process.env.KINDE_POST_LOGOUT_REDIRECT_URL,m=process.env.KINDE_ISSUER_URL,k=process.env.KINDE_CLIENT_ID,y=process.env.KINDE_CLIENT_SECRET,w=process.env.KINDE_AUDIENCE,A={apiPath:d,initialState:{accessToken:null,idToken:null,isAuthenticated:!1,isLoading:!0,organization:null,permissions:[],user:null,userOrganiaztions:[],getAccessToken:()=>null,getBooleanFlag:()=>null,getClaim:()=>null,getFlag:()=>null,getIdToken:()=>null,getIntegerFlag:()=>null,getOrganization:()=>null,getPermission:()=>null,getPermissions:()=>[],getStringFlag:()=>null,getToken:()=>null,getUser:()=>null,getUserOrganizations:()=>null},SESSION_PREFIX:"pkce-verifier",redirectURL:p,postLoginRedirectURL:h,issuerURL:m,clientID:k,clientSecret:y,postLogoutRedirectURL:_,audience:w,responseType:"code",scope:"openid profile email offline",codeChallengeMethod:"S256",redirectRoutes:{callback:`${d}/kinde_callback`},issuerRoutes:{logout:"/logout",login:"/oauth2/auth",register:"/oauth2/auth",token:"/oauth2/token",profile:"/oauth2/v2/user_profile"},clientOptions:{audience:w||"",authDomain:m||"",clientId:k||"",clientSecret:y||"",logoutRedirectURL:_||"",redirectURL:`${p}/api/auth/kinde_callback`,frameworkVersion:"2.0.4",framework:"Next.js"},grantType:t.GrantType.AUTHORIZATION_CODE},S=t.createKindeServerClient(A.grantType,A.clientOptions),f=(e,t)=>async(r,n,s)=>{try{return await S.getFlag(c(e,t),r,n,s)}catch(e){if(e.message.includes("no default value has been provided"))throw e;return{value:n}}},I=(e,t)=>async(r,n)=>{try{return(await f(e,t)(r,n,"b")).value}catch(e){return console.error(e),null}},R=(e,t)=>async()=>await c(e,t).getSessionItem("id_token_payload"),U=(e,t)=>async(r,n)=>{try{return(await f(e,t)(r,n,"i")).value}catch(e){return console.error(e),null}},P=(e,t)=>async()=>{try{return await S.getOrganization(c(e,t))}catch(e){return null}},L=(e,t)=>async r=>{try{return await S.getPermission(c(e,t),r)}catch(e){return null}},C=(e,t)=>async()=>{try{return await S.getPermissions(c(e,t))}catch(e){return null}},T=(e,t)=>async(r,n)=>{try{return(await f(e,t)(r,n,"s")).value}catch(e){return console.error(e),null}},O=(e,t)=>async()=>{try{return await S.getUser(c(e,t))}catch(e){return null}},v=(e,t)=>async()=>{try{return await S.getUserOrganizations(c(e,t))}catch(e){return null}},E=(e,t)=>async()=>{const r=await O(e,t)();return Boolean(r)};function b(){return b=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},b.apply(this,arguments)}class N{constructor(r,n){this.kindeClient=t.createKindeServerClient(A.grantType,A.clientOptions),this.url=new URL(r.url),this.sessionManager=l(e.cookies()),this.req=r,this.searchParams=r.nextUrl.searchParams}redirect(e){return s.redirect(e)}getUrl(){return this.url}json(e,t){return a.NextResponse.json(e,t)}error(){return a.NextResponse.error}getSearchParam(e){return this.req.nextUrl.searchParams.get(e)}}class M{constructor(e,r){this.kindeClient=t.createKindeServerClient(A.grantType,A.clientOptions),this.url=new URL(A.redirectURL+e.url),this.res=r,this.req=e,this.searchParams=this.url.searchParams,this.sessionManager=c(e,r)}redirect(e){return this.res.redirect(e.href?e.href:e)}getUrl(){return this.url}json(e,t=200){return this.res.status(t).json(e)}getSearchParam(e){return this.url.searchParams.get(e)}}const j={create_org:async e=>{const t={org_name:e.getSearchParam("org_name"),is_create_org:!0},r=await e.kindeClient.createOrg(e.sessionManager,t);e.redirect(r)},register:async e=>{const t=await e.kindeClient.register(e.sessionManager,{authUrlParams:Object.fromEntries(e.searchParams)}),r=e.getSearchParam("post_login_redirect_url");r&&await e.sessionManager.setSessionItem("post_login_redirect_url",r),e.redirect(t)},setup:async e=>{const t=await e.sessionManager.getSessionItem("user");if(t){const r=await e.sessionManager.getSessionItem("access_token_payload"),n=await e.sessionManager.getSessionItem("id_token_payload"),s=await e.sessionManager.getSessionItem("access_token"),a=await e.kindeClient.getClaimValue(e.sessionManager,"permissions"),i=await e.kindeClient.getClaimValue(e.sessionManager,"org_code"),o=await e.kindeClient.getClaimValue(e.sessionManager,"feature_flags"),c=await e.kindeClient.getClaimValue(e.sessionManager,"org_codes","id_token");return e.json({accessToken:r,accessTokenEncoded:s,idToken:n,user:t,permissions:{permissions:a,orgCode:i},organization:i,featureFlags:o,userOrganizations:c})}return e.json({error:"Log in with Kinde"},{status:401})},login:async e=>{const t=await e.kindeClient.login(e.sessionManager,{authUrlParams:Object.fromEntries(e.searchParams)}),r=e.getSearchParam("post_login_redirect_url");r&&await e.sessionManager.setSessionItem("post_login_redirect_url",r),e.redirect(t)},logout:async e=>{const t=await e.kindeClient.logout(e.sessionManager);e.redirect(t)},kinde_callback:async e=>{const t=await e.sessionManager.getSessionItem("post_login_redirect_url");t&&await e.sessionManager.removeSessionItem("post_login_redirect_url");const r=t||A.postLoginRedirectURL;await e.kindeClient.handleRedirectToApp(e.sessionManager,e.getUrl()),e.redirect(r)}},D=e=>j[e];const x=async(e,t)=>{const{params:r}=t;let n=r.kindeAuth;n=Array.isArray(n)?n[0]:n;const s=D(n);return s?await s(new N(e,t)):new Response("This page could not be found.",{status:404})},z=async(e,t)=>{let{query:{kindeAuth:r}}=e;r=Array.isArray(r)?r[0]:r;const n=D(r);return n?await n(new M(e,t)):t.status(404).end()};exports.CreateOrgLink=function({children:e,orgName:t,...n}){return r.createElement("a",b({href:`${A.apiPath}/create_org${t?`?org_name=${t}`:""}`},n),e)},exports.LoginLink=function({children:e,postLoginRedirectURL:t,orgCode:n,authUrlParams:s,...a}){let i=new URLSearchParams,o={};null!=n&&(o.org_code=n),null!=t&&(o.post_login_redirect_url=t),o={...s,...o};for(const e in o)i.append(e,o[e]);return r.createElement("a",b({href:`${A.apiPath}/login${i?`?${i.toString()}`:""}`},a),e)},exports.LogoutLink=function({children:e,...t}){return r.createElement("a",b({href:`${A.apiPath}/logout`},t),e)},exports.RegisterLink=function({children:e,orgCode:t,postLoginRedirectURL:n,authUrlParams:s,...a}){let i=new URLSearchParams,o={};null!=t&&(o.org_code=t),null!=n&&(o.post_login_redirect_url=n),o={...s,...o};for(const e in o)i.append(e,o[e]);return r.createElement("a",b({href:`${A.apiPath}/register${i?`?${i.toString()}`:""}`},a),e)},exports.createKindeManagementAPIClient=async(e,r)=>{let s=null;const a=c(e,r),i=a.getSessionItem("kinde_api_access_token");if((e=>{const t=e&&e.access_token||e;if(!t)return!1;const r=n(t,{header:!0}),s=n(t);let a=!0;return A.audience&&(a=s.aud&&s.aud.includes(A.audience)),!!(s.iss==A.issuerURL&&"RS256"==r.alg&&s.exp>Math.floor(Date.now()/1e3)&&a)})(i))s=i;else{const e=await fetch(`${A.issuerURL}/oauth2/token`,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:A.clientID,client_secret:A.clientSecret,audience:A.audience})});s=(await e.json()).access_token;try{a.setSessionItem("kinde_api_access_token",s)}catch(e){console.error(e)}}const o=new t.Configuration({basePath:A.issuerURL,accessToken:s,headers:{Accept:"application/json"}});return{usersApi:new t.UsersApi(o),oauthApi:new t.OAuthApi(o),subscribersApi:new t.SubscribersApi(o),organizationsApi:new t.OrganizationsApi(o),connectedAppsApi:new t.ConnectedAppsApi(o),featureFlagsApi:new t.FeatureFlagsApi(o),environmentsApi:new t.EnvironmentsApi(o),permissionsApi:new t.PermissionsApi(o),rolesApi:new t.RolesApi(o),businessApi:new t.BusinessApi(o),industriesApi:new t.IndustriesApi(o),timezonesApi:new t.TimezonesApi(o),applicationsApi:new t.ApplicationsApi(o),callbacksApi:new t.CallbacksApi(o),apisApi:new t.APIsApi(o)}},exports.getKindeServerSession=function(e,t){return{getAccessToken:g(e,t),getBooleanFlag:I(e,t),getFlag:f(e,t),getIdToken:R(e,t),getIntegerFlag:U(e,t),getOrganization:P(e,t),getPermission:L(e,t),getPermissions:C(e,t),getStringFlag:T(e,t),getUser:O(e,t),getUserOrganizations:v(e,t),isAuthenticated:E(e,t)}},exports.handleAuth=(e,t)=>"object"==typeof e&&"string"==typeof t?x(e,{params:{kindeAuth:t}}):async function(e,t){return i(e)?x(e,t):z(e,t)};
//# sourceMappingURL=index.js.map
