import e,{useContext as n,useState as t,useCallback as r,useEffect as o,createContext as a}from"react";var i,s,l;!function(e){e.AUTHORIZATION_CODE="AUTHORIZATION_CODE",e.CLIENT_CREDENTIALS="CLIENT_CREDENTIALS",e.PKCE="PKCE"}(i||(i={})),function(e){e.s="string",e.b="boolean",e.i="number"}(s||(s={})),function(e){e.BROWSER="BROWSER",e.NODEJS="NODEJS"}(l||(l={})),"undefined"==typeof window?l.NODEJS:l.BROWSER;const c=process.env.KINDE_SITE_URL,g=process.env.NEXT_PUBLIC_KINDE_AUTH_API_PATH||process.env.KINDE_AUTH_API_PATH||"/api/auth",u=process.env.KINDE_POST_LOGIN_REDIRECT_URL||process.env.KINDE_POST_LOGIN_URL_REDIRECT_URL,d=process.env.KINDE_POST_LOGOUT_REDIRECT_URL,p=process.env.KINDE_ISSUER_URL,h=process.env.KINDE_CLIENT_ID,f=process.env.KINDE_CLIENT_SECRET,T=process.env.KINDE_AUDIENCE,E={apiPath:g,initialState:{accessToken:null,idToken:null,isAuthenticated:!1,isLoading:!0,organization:null,permissions:[],user:null,userOrganiaztions:[],getAccessToken:()=>null,getBooleanFlag:()=>null,getClaim:()=>null,getFlag:()=>null,getIdToken:()=>null,getIntegerFlag:()=>null,getOrganization:()=>null,getPermission:()=>null,getPermissions:()=>[],getStringFlag:()=>null,getToken:()=>null,getUser:()=>null,getUserOrganizations:()=>null},SESSION_PREFIX:"pkce-verifier",redirectURL:c,postLoginRedirectURL:u,issuerURL:p,clientID:h,clientSecret:f,postLogoutRedirectURL:d,audience:T,responseType:"code",scope:"openid profile email offline",codeChallengeMethod:"S256",redirectRoutes:{callback:`${g}/kinde_callback`},issuerRoutes:{logout:"/logout",login:"/oauth2/auth",register:"/oauth2/auth",token:"/oauth2/token",profile:"/oauth2/v2/user_profile"},clientOptions:{audience:T||"",authDomain:p||"",clientId:h||"",clientSecret:f||"",logoutRedirectURL:d||"",redirectURL:`${c}/api/auth/kinde_callback`,frameworkVersion:"2.0.4",framework:"Next.js"},grantType:i.AUTHORIZATION_CODE},k={s:"string",i:"integer",b:"boolean"},_=a({...E.initialState}),I=()=>n(_),m=({children:n})=>{const[a,i]=t({...E.initialState}),s=`${E.apiPath}/setup`,l=r((async()=>{try{const e=await(async e=>{let n;try{n=await fetch(e)}catch{throw new Error("Failed to fetch token")}if(n.ok)return await n.json();if(401===n.status)throw new Error("Failed to fetch token")})(s);if(null==e)return;const{accessToken:n,accessTokenEncoded:t,featureFlags:r,idToken:o,organization:a,permissions:l,user:c,userOrganizations:g}=e,u=()=>n,d=()=>t,p=()=>o,h=()=>l,f=()=>a,T=()=>c,E=()=>g,_=(n,t="access_token")=>{const r="access_token"===t?e.accessToken:e.idToken;return r?{name:n,value:r[n]}:null},I=(e,n,t)=>{const o=r,a=o&&o[e]?o[e]:{};if(a=={}&&null==n)throw Error(`Flag ${e} was not found, and no default value has been provided`);if(t&&a.t&&t!==a.t)throw Error(`Flag ${e} is of type ${k[a.t]} - requested type ${k[t]}`);return{code:e,type:k[a.t||t],value:null==a.v?n:a.v,is_default:null==a.v,defaultValue:n}},m=(e,n)=>{try{return I(e,n,"b").value}catch(e){console.error(e)}},v=(e,n)=>{try{return I(e,n,"s").value}catch(e){console.error(e)}},O=(e,n)=>{try{return I(e,n,"i").value}catch(e){console.error(e)}},R=e=>({isGranted:l.permissions.some((n=>n===e)),orgCode:a.orgCode});i((e=>({...e,accessToken:n,idToken:o,isLoading:!1,organization:a,permissions:l,user:c,userOrganizations:g,getAccessToken:u,getBooleanFlag:m,getClaim:_,getFlag:I,getIdToken:p,getIntegerFlag:O,getOrganization:f,getPermission:R,getPermissions:h,getStringFlag:v,getToken:d,getUser:T,getUserOrganizations:E})))}catch(e){i((n=>({...n,isLoading:!1,error:e})))}}),[s]);o((()=>{a.user||(async()=>{await l(),i((e=>({...e,isLoading:!1})))})()}),[a.user]);const{user:c,accessToken:g,idToken:u,getAccessToken:d,getToken:p,getClaim:h,getFlag:f,getIdToken:T,getBooleanFlag:I,getStringFlag:m,getIntegerFlag:v,getOrganization:O,getPermission:R,getPermissions:w,getUser:L,getUserOrganizations:U,permissions:S,organization:C,userOrganizations:y,error:P,isLoading:F}=a;return e.createElement(_.Provider,{value:{user:c,error:P,accessToken:g,idToken:u,getAccessToken:d,getToken:p,getClaim:h,getFlag:f,getIdToken:T,getBooleanFlag:I,getStringFlag:m,getIntegerFlag:v,getOrganization:O,getPermission:R,getPermissions:w,getUser:L,getUserOrganizations:U,permissions:S,organization:C,userOrganizations:y,isLoading:F,isAuthenticated:!!c}},n)},v=()=>{const[e,n]=t({accessToken:null,accessTokenEncoded:null,error:null,featureFlags:[],idToken:null,isAuthenticated:!1,isLoading:!0,organization:null,permissions:[],user:null,userOrganizations:[]});o((()=>{(async()=>{const e=await fetch("/api/auth/setup"),t=await e.json();200==e.status&&n({...t});const r=t.error;n((e=>({...e,isLoading:!1,error:r})))})()}),[]);const r=(n,t,r)=>{const o=e.featureFlags||[],a=o&&o[n]?o[n]:{};if(a=={}&&null==t)throw Error(`Flag ${n} was not found, and no default value has been provided`);if(r&&a.t&&r!==a.t)throw Error(`Flag ${n} is of type ${k[a.t]} - requested type ${k[r]}`);return{code:n,type:k[a.t||r],value:null==a.v?t:a.v,is_default:null==a.v}};return{...e,isAuthenticated:!!e.user,getPermission:n=>({isGranted:e.permissions.some((e=>e===n)),orgCode:e.organization}),getBooleanFlag:(e,n)=>{try{return r(e,n,"b").value}catch(e){console.error(e)}},getIntegerFlag:(e,n)=>{try{return r(e,n,"i").value}catch(e){console.error(e)}},getFlag:r,getStringFlag:(e,n)=>{try{return r(e,n,"s").value}catch(e){console.error(e)}},getClaim:(n,t="access_token")=>{const r="access_token"===t?e.accessToken:e.idToken;return r?{name:n,value:r[n]}:null},getAccessToken:()=>e.accessToken,getToken:()=>e.accessTokenEncoded,getIdToken:()=>e.idToken,getOrganization:()=>e.organization,getPermissions:()=>e.permissions,getUserOrganizations:()=>e.userOrganizations}};function O(e){this.message=e}O.prototype=new Error,O.prototype.name="InvalidCharacterError";var R="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var n=String(e).replace(/=+$/,"");if(n.length%4==1)throw new O("'atob' failed: The string to be decoded is not correctly encoded.");for(var t,r,o=0,a=0,i="";r=n.charAt(a++);~r&&(t=o%4?64*t+r:r,o++%4)?i+=String.fromCharCode(255&t>>(-2*o&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return i};function w(e){var n=e.replace(/-/g,"+").replace(/_/g,"/");switch(n.length%4){case 0:break;case 2:n+="==";break;case 3:n+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(R(e).replace(/(.)/g,(function(e,n){var t=n.charCodeAt(0).toString(16).toUpperCase();return t.length<2&&(t="0"+t),"%"+t})))}(n)}catch(e){return R(n)}}function L(e){this.message=e}function U(e,n){if("string"!=typeof e)throw new L("Invalid token specified");var t=!0===(n=n||{}).header?0:1;try{return JSON.parse(w(e.split(".")[t]))}catch(e){throw new L("Invalid token specified: "+e.message)}}L.prototype=new Error,L.prototype.name="InvalidTokenError";const S=e=>{const n=e&&e.access_token||e;if(!n)return!1;const t=U(n,{header:!0}),r=U(n);let o=!0;return E.audience&&(o=r.aud&&r.aud.includes(E.audience)),!!(r.iss==E.issuerURL&&"RS256"==t.alg&&r.exp>Math.floor(Date.now()/1e3)&&o)};function C(){return C=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},C.apply(this,arguments)}function y({children:n,orgCode:t,postLoginRedirectURL:r,authUrlParams:o,...a}){let i=new URLSearchParams,s={};null!=t&&(s.org_code=t),null!=r&&(s.post_login_redirect_url=r),s={...o,...s};for(const e in s)i.append(e,s[e]);return e.createElement("a",C({href:`${E.apiPath}/register${i?`?${i.toString()}`:""}`},a),n)}function P({children:n,postLoginRedirectURL:t,orgCode:r,authUrlParams:o,...a}){let i=new URLSearchParams,s={};null!=r&&(s.org_code=r),null!=t&&(s.post_login_redirect_url=t),s={...o,...s};for(const e in s)i.append(e,s[e]);return e.createElement("a",C({href:`${E.apiPath}/login${i?`?${i.toString()}`:""}`},a),n)}function F({children:n,...t}){return e.createElement("a",C({href:`${E.apiPath}/logout`},t),n)}function N({children:n,orgName:t,...r}){return e.createElement("a",C({href:`${E.apiPath}/create_org${t?`?org_name=${t}`:""}`},r),n)}export{N as CreateOrgLink,m as KindeProvider,P as LoginLink,F as LogoutLink,y as RegisterLink,S as isTokenValid,I as useKindeAuth,v as useKindeBrowserClient};
//# sourceMappingURL=index.js.map
