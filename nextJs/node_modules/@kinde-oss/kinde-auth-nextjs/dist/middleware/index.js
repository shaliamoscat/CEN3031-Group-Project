import{NextResponse as e}from"next/server";import{GrantType as t}from"@kinde-oss/kinde-typescript-sdk";import n from"jwt-decode";const o=process.env.KINDE_SITE_URL,r=process.env.NEXT_PUBLIC_KINDE_AUTH_API_PATH||process.env.KINDE_AUTH_API_PATH||"/api/auth",s=process.env.KINDE_POST_LOGIN_REDIRECT_URL||process.env.KINDE_POST_LOGIN_URL_REDIRECT_URL,i=process.env.KINDE_POST_LOGOUT_REDIRECT_URL,c=process.env.KINDE_ISSUER_URL,a=process.env.KINDE_CLIENT_ID,l=process.env.KINDE_CLIENT_SECRET,u=process.env.KINDE_AUDIENCE,g={apiPath:r,initialState:{accessToken:null,idToken:null,isAuthenticated:!1,isLoading:!0,organization:null,permissions:[],user:null,userOrganiaztions:[],getAccessToken:()=>null,getBooleanFlag:()=>null,getClaim:()=>null,getFlag:()=>null,getIdToken:()=>null,getIntegerFlag:()=>null,getOrganization:()=>null,getPermission:()=>null,getPermissions:()=>[],getStringFlag:()=>null,getToken:()=>null,getUser:()=>null,getUserOrganizations:()=>null},SESSION_PREFIX:"pkce-verifier",redirectURL:o,postLoginRedirectURL:s,issuerURL:c,clientID:a,clientSecret:l,postLogoutRedirectURL:i,audience:u,responseType:"code",scope:"openid profile email offline",codeChallengeMethod:"S256",redirectRoutes:{callback:`${r}/kinde_callback`},issuerRoutes:{logout:"/logout",login:"/oauth2/auth",register:"/oauth2/auth",token:"/oauth2/token",profile:"/oauth2/v2/user_profile"},clientOptions:{audience:u||"",authDomain:c||"",clientId:a||"",clientSecret:l||"",logoutRedirectURL:i||"",redirectURL:`${o}/api/auth/kinde_callback`,frameworkVersion:"2.0.4",framework:"Next.js"},grantType:t.AUTHORIZATION_CODE},_=e=>e&&"/"===e.charAt(e.length-1)?e.slice(0,-1):e;function d(t){let n=!1;const o=_(t.nextUrl.href)===_(g.postLogoutRedirectURL);return t.cookies.get("access_token")&&(n=!0),n||o?n&&o?e.redirect(new URL(g.postLoginRedirectURL)):e.next():e.redirect(new URL(g.postLogoutRedirectURL,t.url))}const p=async(t,o,r)=>{const{pathname:s}=t.nextUrl,i=o?.loginPage||"/api/auth/login";if(i==s||["/_next","/favicon.ico"].some((e=>s.startsWith(e))))return;const c=t.cookies.get("access_token");if(!c){return e.redirect(new URL(`${i}?post_login_redirect_url=${s}`,g.redirectURL))}const a=JSON.parse(t.cookies.get("access_token_payload").value),l=o?.isAuthorized({req:t,token:a})??(e=>{const t=e&&e.access_token||e;if(!t)return!1;const o=n(t,{header:!0}),r=n(t);let s=!0;return g.audience&&(s=r.aud&&r.aud.includes(g.audience)),!!(r.iss==g.issuerURL&&"RS256"==o.alg&&r.exp>Math.floor(Date.now()/1e3)&&s)})(c.value);return l&&r?await r({token:JSON.parse(t.cookies.get("access_token_payload").value),user:JSON.parse(t.cookies.get("user").value)}):l?void 0:e.redirect(new URL(`${i}?post_login_redirect_url=${s}`,g.redirectURL))};function R(...e){if(!e.length||e[0]instanceof Request)return p(...e);if("function"==typeof e[0]){const t=e[0],n=e[1];return async(...e)=>await p(e[0],n,(async({token:n,user:o})=>(e[0].kindeAuth={token:n,user:o},await t(...e))))}const t=e[0];return async(...e)=>await p(e[0],t)}export{d as authMiddleware,R as withAuth};
//# sourceMappingURL=index.js.map
