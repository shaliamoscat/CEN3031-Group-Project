"use strict";var e=require("next/server"),t=require("@kinde-oss/kinde-typescript-sdk"),n=require("jwt-decode");const o=process.env.KINDE_SITE_URL,s=process.env.NEXT_PUBLIC_KINDE_AUTH_API_PATH||process.env.KINDE_AUTH_API_PATH||"/api/auth",r=process.env.KINDE_POST_LOGIN_REDIRECT_URL||process.env.KINDE_POST_LOGIN_URL_REDIRECT_URL,i=process.env.KINDE_POST_LOGOUT_REDIRECT_URL,a=process.env.KINDE_ISSUER_URL,c=process.env.KINDE_CLIENT_ID,l=process.env.KINDE_CLIENT_SECRET,u=process.env.KINDE_AUDIENCE,p={apiPath:s,initialState:{accessToken:null,idToken:null,isAuthenticated:!1,isLoading:!0,organization:null,permissions:[],user:null,userOrganiaztions:[],getAccessToken:()=>null,getBooleanFlag:()=>null,getClaim:()=>null,getFlag:()=>null,getIdToken:()=>null,getIntegerFlag:()=>null,getOrganization:()=>null,getPermission:()=>null,getPermissions:()=>[],getStringFlag:()=>null,getToken:()=>null,getUser:()=>null,getUserOrganizations:()=>null},SESSION_PREFIX:"pkce-verifier",redirectURL:o,postLoginRedirectURL:r,issuerURL:a,clientID:c,clientSecret:l,postLogoutRedirectURL:i,audience:u,responseType:"code",scope:"openid profile email offline",codeChallengeMethod:"S256",redirectRoutes:{callback:`${s}/kinde_callback`},issuerRoutes:{logout:"/logout",login:"/oauth2/auth",register:"/oauth2/auth",token:"/oauth2/token",profile:"/oauth2/v2/user_profile"},clientOptions:{audience:u||"",authDomain:a||"",clientId:c||"",clientSecret:l||"",logoutRedirectURL:i||"",redirectURL:`${o}/api/auth/kinde_callback`,frameworkVersion:"2.0.4",framework:"Next.js"},grantType:t.GrantType.AUTHORIZATION_CODE},g=e=>e&&"/"===e.charAt(e.length-1)?e.slice(0,-1):e;const _=async(t,o,s)=>{const{pathname:r}=t.nextUrl,i=o?.loginPage||"/api/auth/login";if(i==r||["/_next","/favicon.ico"].some((e=>r.startsWith(e))))return;const a=t.cookies.get("access_token");if(!a){return e.NextResponse.redirect(new URL(`${i}?post_login_redirect_url=${r}`,p.redirectURL))}const c=JSON.parse(t.cookies.get("access_token_payload").value),l=o?.isAuthorized({req:t,token:c})??(e=>{const t=e&&e.access_token||e;if(!t)return!1;const o=n(t,{header:!0}),s=n(t);let r=!0;return p.audience&&(r=s.aud&&s.aud.includes(p.audience)),!!(s.iss==p.issuerURL&&"RS256"==o.alg&&s.exp>Math.floor(Date.now()/1e3)&&r)})(a.value);return l&&s?await s({token:JSON.parse(t.cookies.get("access_token_payload").value),user:JSON.parse(t.cookies.get("user").value)}):l?void 0:e.NextResponse.redirect(new URL(`${i}?post_login_redirect_url=${r}`,p.redirectURL))};exports.authMiddleware=function(t){let n=!1;const o=g(t.nextUrl.href)===g(p.postLogoutRedirectURL);return t.cookies.get("access_token")&&(n=!0),n||o?n&&o?e.NextResponse.redirect(new URL(p.postLoginRedirectURL)):e.NextResponse.next():e.NextResponse.redirect(new URL(p.postLogoutRedirectURL,t.url))},exports.withAuth=function(...e){if(!e.length||e[0]instanceof Request)return _(...e);if("function"==typeof e[0]){const t=e[0],n=e[1];return async(...e)=>await _(e[0],n,(async({token:n,user:o})=>(e[0].kindeAuth={token:n,user:o},await t(...e))))}const t=e[0];return async(...e)=>await _(e[0],t)};
//# sourceMappingURL=index.js.map
