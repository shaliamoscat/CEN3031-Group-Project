{"version":3,"file":"index.js","sources":["../../../src/utils/version.js","../../../src/config/index.js","../../../src/middleware/index.js","../../../src/utils/pageRouter/isTokenValid.js"],"sourcesContent":["// Generated by genversion.\nexport const version = '2.0.4'\n","import {GrantType} from '@kinde-oss/kinde-typescript-sdk';\nimport {version} from '../utils/version';\n\n/**\n * @type {import('../../types').KindeState}\n */\nconst initialState = {\n  accessToken: null,\n  idToken: null,\n  isAuthenticated: false,\n  isLoading: true,\n  organization: null,\n  permissions: [],\n  user: null,\n  userOrganiaztions: [],\n  getAccessToken: () => null,\n  getBooleanFlag: () => null,\n  getClaim: () => null,\n  getFlag: () => null,\n  getIdToken: () => null,\n  getIntegerFlag: () => null,\n  getOrganization: () => null,\n  getPermission: () => null,\n  getPermissions: () => [],\n  getStringFlag: () => null,\n  getToken: () => null,\n  getUser: () => null,\n  getUserOrganizations: () => null\n};\n\nconst SESSION_PREFIX = 'pkce-verifier';\n\nconst KINDE_SITE_URL = process.env.KINDE_SITE_URL;\n\n// We need to use NEXT_PUBLIC for frontend vars\nconst KINDE_AUTH_API_PATH =\n  process.env.NEXT_PUBLIC_KINDE_AUTH_API_PATH ||\n  process.env.KINDE_AUTH_API_PATH ||\n  '/api/auth';\n\nconst KINDE_POST_LOGIN_REDIRECT_URL =\n  process.env.KINDE_POST_LOGIN_REDIRECT_URL ||\n  process.env.KINDE_POST_LOGIN_URL_REDIRECT_URL;\nconst KINDE_POST_LOGOUT_REDIRECT_URL =\n  process.env.KINDE_POST_LOGOUT_REDIRECT_URL;\n\nconst KINDE_ISSUER_URL = process.env.KINDE_ISSUER_URL;\nconst KINDE_CLIENT_ID = process.env.KINDE_CLIENT_ID;\nconst KINDE_CLIENT_SECRET = process.env.KINDE_CLIENT_SECRET;\nconst KINDE_AUDIENCE = process.env.KINDE_AUDIENCE;\n\nexport const config = {\n  apiPath: KINDE_AUTH_API_PATH,\n  initialState,\n  SESSION_PREFIX,\n  redirectURL: KINDE_SITE_URL,\n  postLoginRedirectURL: KINDE_POST_LOGIN_REDIRECT_URL,\n  issuerURL: KINDE_ISSUER_URL,\n  clientID: KINDE_CLIENT_ID,\n  clientSecret: KINDE_CLIENT_SECRET,\n  postLogoutRedirectURL: KINDE_POST_LOGOUT_REDIRECT_URL,\n  audience: KINDE_AUDIENCE,\n  responseType: 'code',\n  scope: 'openid profile email offline',\n  codeChallengeMethod: 'S256',\n  redirectRoutes: {\n    callback: `${KINDE_AUTH_API_PATH}/kinde_callback`\n  },\n  issuerRoutes: {\n    logout: '/logout',\n    login: '/oauth2/auth',\n    register: '/oauth2/auth',\n    token: '/oauth2/token',\n    profile: '/oauth2/v2/user_profile'\n  },\n  clientOptions: {\n    audience: KINDE_AUDIENCE || '',\n    authDomain: KINDE_ISSUER_URL || '',\n    clientId: KINDE_CLIENT_ID || '',\n    clientSecret: KINDE_CLIENT_SECRET || '',\n    logoutRedirectURL: KINDE_POST_LOGOUT_REDIRECT_URL || '',\n    redirectURL: `${KINDE_SITE_URL}/api/auth/kinde_callback`,\n    frameworkVersion: version,\n    framework: 'Next.js'\n  },\n  grantType: GrantType.AUTHORIZATION_CODE\n};\n","import {NextResponse} from 'next/server';\nimport {config} from '../config/index';\nimport {isTokenValid} from '../utils/pageRouter/isTokenValid';\n\nconst trimTrailingSlash = (str) =>\n  str && str.charAt(str.length - 1) === '/' ? str.slice(0, -1) : str;\n\nexport function authMiddleware(request) {\n  let isAuthenticated = false;\n  const nextUrl = trimTrailingSlash(request.nextUrl.href);\n  const logoutUrl = trimTrailingSlash(config.postLogoutRedirectURL);\n  const kinde_token = request.cookies.get('access_token');\n  const isLogoutUrl = nextUrl === logoutUrl;\n\n  if (kinde_token) {\n    isAuthenticated = true;\n  }\n\n  if (!isAuthenticated && !isLogoutUrl) {\n    return NextResponse.redirect(\n      new URL(config.postLogoutRedirectURL, request.url)\n    );\n  }\n\n  if (isAuthenticated && isLogoutUrl) {\n    return NextResponse.redirect(new URL(config.postLoginRedirectURL));\n  }\n\n  return NextResponse.next();\n}\n\nconst handleMiddleware = async (req, options, onSuccess) => {\n  const {pathname} = req.nextUrl;\n\n  const loginPage = options?.loginPage || '/api/auth/login';\n  const publicPaths = ['/_next', '/favicon.ico'];\n\n  if (loginPage == pathname || publicPaths.some((p) => pathname.startsWith(p)))\n    return;\n\n  const kindeToken = req.cookies.get('access_token');\n\n  if (!kindeToken) {\n    const response = NextResponse.redirect(\n      new URL(\n        `${loginPage}?post_login_redirect_url=${pathname}`,\n        config.redirectURL\n      )\n    );\n    return response;\n  }\n\n  const accessTokenValue = JSON.parse(\n    req.cookies.get('access_token_payload').value\n  );\n\n  const isAuthorized =\n    options?.isAuthorized({req, token: accessTokenValue}) ??\n    isTokenValid(kindeToken.value);\n\n  if (isAuthorized && onSuccess) {\n    return await onSuccess({\n      token: JSON.parse(req.cookies.get('access_token_payload').value),\n      user: JSON.parse(req.cookies.get('user').value)\n    });\n  }\n\n  if (isAuthorized) {\n    return;\n  }\n\n  return NextResponse.redirect(\n    new URL(\n      `${loginPage}?post_login_redirect_url=${pathname}`,\n      config.redirectURL\n    )\n  );\n};\n\n/**\n * @param {Request} [req]\n * @param {function(req: Request & {kindeAuth: {user: any, token: string}})} [onIsAuthorized]\n */\nexport function withAuth(...args) {\n  // most basic usage - no options\n  if (!args.length || args[0] instanceof Request) {\n    return handleMiddleware(...args);\n  }\n\n  // passing through the kindeAuth data to the middleware function\n  if (typeof args[0] === 'function') {\n    const middleware = args[0];\n    const options = args[1];\n    return async (...args) =>\n      await handleMiddleware(args[0], options, async ({token, user}) => {\n        args[0].kindeAuth = {token, user};\n        return await middleware(...args);\n      });\n  }\n\n  // includes options\n  const options = args[0];\n  return async (...args) => await handleMiddleware(args[0], options);\n}\n","import jwt_decode from 'jwt-decode';\nimport {config} from '../../config/index';\n\nconst isTokenValid = (token) => {\n  const accessToken = (token && token.access_token) || token;\n  if (!accessToken) return false;\n\n  const accessTokenHeader = jwt_decode(accessToken, {header: true});\n  const accessTokenPayload = jwt_decode(accessToken);\n  let isAudienceValid = true;\n  if (config.audience)\n    isAudienceValid =\n      accessTokenPayload.aud &&\n      accessTokenPayload.aud.includes(config.audience);\n\n  if (\n    accessTokenPayload.iss == config.issuerURL &&\n    accessTokenHeader.alg == 'RS256' &&\n    accessTokenPayload.exp > Math.floor(Date.now() / 1000) &&\n    isAudienceValid\n  ) {\n    return true;\n  } else {\n    return false;\n  }\n};\n\nexport {isTokenValid};\n"],"names":["KINDE_SITE_URL","process","env","KINDE_AUTH_API_PATH","NEXT_PUBLIC_KINDE_AUTH_API_PATH","KINDE_POST_LOGIN_REDIRECT_URL","KINDE_POST_LOGIN_URL_REDIRECT_URL","KINDE_POST_LOGOUT_REDIRECT_URL","KINDE_ISSUER_URL","KINDE_CLIENT_ID","KINDE_CLIENT_SECRET","KINDE_AUDIENCE","config","apiPath","initialState","accessToken","idToken","isAuthenticated","isLoading","organization","permissions","user","userOrganiaztions","getAccessToken","getBooleanFlag","getClaim","getFlag","getIdToken","getIntegerFlag","getOrganization","getPermission","getPermissions","getStringFlag","getToken","getUser","getUserOrganizations","SESSION_PREFIX","redirectURL","postLoginRedirectURL","issuerURL","clientID","clientSecret","postLogoutRedirectURL","audience","responseType","scope","codeChallengeMethod","redirectRoutes","callback","issuerRoutes","logout","login","register","token","profile","clientOptions","authDomain","clientId","logoutRedirectURL","frameworkVersion","framework","grantType","GrantType","AUTHORIZATION_CODE","trimTrailingSlash","str","charAt","length","slice","handleMiddleware","async","req","options","onSuccess","pathname","nextUrl","loginPage","some","p","startsWith","kindeToken","cookies","get","NextResponse","redirect","URL","accessTokenValue","JSON","parse","value","isAuthorized","access_token","accessTokenHeader","jwt_decode","header","accessTokenPayload","isAudienceValid","aud","includes","iss","alg","exp","Math","floor","Date","now","isTokenValid","request","isLogoutUrl","href","next","url","args","Request","middleware","kindeAuth"],"mappings":"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"}